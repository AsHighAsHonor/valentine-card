<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Royal Decree - Bankwest IT 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@300;400;700&family=Great+Vibes&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Post-processing -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>

    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #fceabb;
            --ruby: #9b111e;
            --velvet-base: #590d0d;
            --velvet-light: #8a1c1c;
            --paper-cream: #fff9f0;
            --card-width: 400px;
            --card-height: 560px;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: #050101;
            font-family: 'Lato', sans-serif;
        }

        #canvas-container {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #dim-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: black;
            opacity: 0;
            z-index: 5;
            pointer-events: none;
            transition: opacity 4s ease;
        }

        /* === Physical Card Structure === */
        #card-wrapper {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            width: var(--card-width);
            height: var(--card-height);
            transition: transform 0.8s ease-in-out, opacity 1s ease;
            perspective: 2500px;
            pointer-events: auto;
        }
        
        #card-wrapper.open {
            transform: translate(-50%, -50%);
        }

        .scene-wrapper { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            transform-style: preserve-3d;
            transition: transform 0.8s ease-in-out;
        }
        
        /* Centering the opened spread by translating right by half card width */
        .open .scene-wrapper { transform: translateX(calc(var(--card-width) / 2)); }

        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
            cursor: pointer;
        }
        .card-inner.is-open { transform: rotateY(-175deg); }

        .velvet-texture {
            background-color: var(--velvet-base);
            background-image: radial-gradient(circle at 30% 30%, var(--velvet-light) 0%, transparent 40%), 
                              radial-gradient(circle at 70% 70%, var(--velvet-light) 0%, transparent 40%), 
                              repeating-linear-gradient(45deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 2px, transparent 2px, transparent 4px);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.6);
        }

        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 8px 16px 16px 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }

        .card-front {
            z-index: 2; border: 4px solid var(--velvet-base);
            outline: 2px solid var(--gold); outline-offset: -12px;
        }
        .card-front::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); pointer-events: none; z-index: 1; }

        .card-back {
            background: var(--paper-cream); transform: rotateY(180deg);
            z-index: 1; box-shadow: inset -20px 0 30px rgba(0,0,0,0.1);
            outline: 1px dashed rgba(212, 175, 55, 0.4); outline-offset: -20px;
            display: flex; align-items: center; justify-content: center;
        }

        .card-inside-right {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--paper-cream); border-radius: 8px 16px 16px 8px; z-index: -1;
            box-shadow: inset 20px 0 30px rgba(0,0,0,0.1), 10px 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; padding: 40px; box-sizing: border-box;
            border: 1px solid #eec; outline: 1px dashed rgba(212, 175, 55, 0.4); outline-offset: -10px;
            opacity: 0; transition: opacity 0.3s;
        }
        .open .card-inside-right { opacity: 1; z-index: 1; pointer-events: auto; transition-delay: 0.2s; }

        /* Decorations */
        .gold-heart-border {
            position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 1px solid var(--gold); pointer-events: none; z-index: 10;
        }
        .border-heart {
            position: absolute; width: 22px; height: 22px; background: var(--gold);
            -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>') no-repeat center;
            mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>') no-repeat center;
            background-size: contain; box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }
        .bh-tl { top: -11px; left: -11px; transform: rotate(-45deg); }
        .bh-tr { top: -11px; right: -11px; transform: rotate(45deg); }
        .bh-bl { bottom: -11px; left: -11px; transform: rotate(-135deg); }
        .bh-br { bottom: -11px; right: -11px; transform: rotate(135deg); }
        .bh-tm { top: -11px; left: 50%; transform: translateX(-50%); }
        .bh-bm { bottom: -11px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .bh-lm { left: -11px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .bh-rm { right: -11px; top: 50%; transform: translateY(-50%) rotate(90deg); }

        .ruby-container { cursor: pointer; z-index: 10; transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ruby-container:hover { transform: scale(1.1); }

        .title-handwritten {
            font-family: 'Great Vibes', cursive;
            background: linear-gradient(to bottom, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            filter: drop-shadow(0 2px 10px rgba(0,0,0,0.5));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .title-handwritten.t-large { font-size: 4.5rem; }
        .title-handwritten.t-small { font-size: 2.5rem; }

        .ruby-gem { 
            font-size: 8rem; 
            color: #ff3333; 
            filter: drop-shadow(0 0 25px rgba(255, 20, 20, 0.9)); 
            animation: heartbeat 2.5s infinite; 
        }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 15% { transform: scale(1.1); } 30% { transform: scale(1); } }

        /* Legacy Code Watermark */
        .watermark-legacy {
            opacity: 0.35; transform: rotate(-10deg); pointer-events: none;
            text-align: center; color: var(--velvet-base); padding: 20px;
        }
        .watermark-legacy i { font-size: 5rem; margin-bottom: 1rem; }

        #heart-target {
            position: fixed; width: 80px; height: 80px; display: none; align-items: center; justify-content: center;
            background: rgba(212, 175, 55, 0.15); backdrop-filter: blur(12px); border: 1.5px solid var(--gold);
            border-radius: 50%; cursor: pointer; z-index: 200; box-shadow: 0 0 40px rgba(212, 175, 55, 0.3);
        }
        #heart-target i { font-size: 32px; color: #ff3333; filter: drop-shadow(0 0 20px rgba(255, 0, 0, 0.8)); animation: heartPulse 1.4s infinite; }
        @keyframes heartPulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.4); opacity: 1; } }

        .rose-quote-overlay {
            position: fixed; bottom: 10%; left: 50%; transform: translateX(-50%); width: 90%;
            max-width: 800px; text-align: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 3s ease;
        }
        .quote-text { font-family: 'Great Vibes', cursive; font-size: 2.2rem; color: var(--gold); line-height: 1.4; margin-bottom: 15px; text-shadow: 0 0 15px rgba(212, 175, 55, 0.6); }

        .instruction { color: var(--gold); letter-spacing: 6px; font-size: 0.8rem; margin-top: 40px; opacity: 0.6; text-transform: uppercase; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }

        .font-retro { font-family: 'VT323', monospace; }
        .font-royal { font-family: 'Cinzel', serif; }
        .font-script { font-family: 'Great Vibes', cursive; }

        @media (max-height: 700px) { #card-wrapper { transform: translate(-50%, -50%) scale(0.85); } #card-wrapper.open { transform: translate(-50%, -50%) scale(0.85); } }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="dim-overlay"></div>
    
    <div id="card-wrapper">
        <div class="scene-wrapper" id="scene">
            <div class="card-cover-axis" id="cover-axis">
                <!-- Front -->
                <div class="card-face cover-front velvet-texture" onclick="openBook()">
                    <div class="gold-heart-border">
                        <div class="border-heart bh-tl"></div><div class="border-heart bh-tr"></div>
                        <div class="border-heart bh-bl"></div><div class="border-heart bh-br"></div>
                        <div class="border-heart bh-tm"></div><div class="border-heart bh-bm"></div>
                        <div class="border-heart bh-lm"></div><div class="border-heart bh-rm"></div>
                    </div>
                    <div class="ruby-container flex flex-col items-center">
                        <div class="mb-6 relative">
                            <i class="fa-solid fa-heart ruby-gem"></i>
                        </div>
                        <h3 class="title-handwritten t-small mb-0">A Royal</h3>
                        <h1 class="title-handwritten t-large">Decree</h1>
                        <p class="instruction">Tap to Unveil</p>
                    </div>
                </div>
                <!-- Back (Opened Left Page) -->
                <div class="card-face cover-back">
                    <div class="gold-heart-border" style="border-color: rgba(74, 5, 5, 0.1);">
                        <div class="border-heart bh-tl" style="background: rgba(74, 5, 5, 0.2);"></div><div class="border-heart bh-tr" style="background: rgba(74, 5, 5, 0.2);"></div>
                        <div class="border-heart bh-bl" style="background: rgba(74, 5, 5, 0.2);"></div><div class="border-heart bh-br" style="background: rgba(74, 5, 5, 0.2);"></div>
                    </div>
                    <div class="watermark-legacy">
                        <i class="fa-solid fa-heart-crack text-6xl mb-4"></i>
                        <p class="font-royal text-xl tracking-widest uppercase">Legacy Code</p>
                        <p class="font-script text-2xl">(Left Behind)</p>
                    </div>
                </div>
            </div>
            
            <!-- Inside Right Page -->
            <div class="card-inside-right">
                <div class="gold-heart-border" style="border-color: rgba(74, 5, 5, 0.1);">
                    <div class="border-heart bh-tl" style="background: rgba(74, 5, 5, 0.2);"></div><div class="border-heart bh-tr" style="background: rgba(74, 5, 5, 0.2);"></div>
                    <div class="border-heart bh-bl" style="background: rgba(74, 5, 5, 0.2);"></div><div class="border-heart bh-br" style="background: rgba(74, 5, 5, 0.2);"></div>
                </div>
                <div class="inside-content flex-grow flex flex-col">
                    <div class="text-center mb-6">
                        <i class="fa-solid fa-crown text-2xl text-yellow-600 mb-2"></i>
                        <h2 class="font-royal text-xl text-red-900 font-bold border-b border-yellow-200 pb-2 inline-block">The Final Commit</h2>
                    </div>
                    <div class="flex-grow flex flex-col items-center text-center">
                        <p class="font-script text-4xl text-red-900 mb-6">Initial Commit: Forever.</p>
                        <p class="text-gray-800 italic leading-relaxed text-lg mb-6">From the very first line of our story, I knew this was the <strong class="text-red-700">Main Branch</strong>.</p>
                        <p class="text-gray-700 leading-relaxed">You are the logic that makes sense of my chaos, and the only user with <strong class="text-yellow-700">Superuser</strong> privileges.</p>
                        
                        <div class="bg-[#fcf8e3] border border-orange-200 p-5 shadow-inner w-full mt-10 rotate-1 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-orange-400 opacity-30 animate-pulse"></div>
                            <code class="font-retro text-base text-gray-700 block text-left leading-snug">
                                <span class="text-orange-600">Locked, Merged, and Committed. üíõ</span><br>
                                <span class="text-green-600">> Status: Relationship Deployed to Production</span><br>
                                <span class="text-green-600">> Uptime: Eternal</span>
                            </code>
                        </div>
                        <p class="instruction" style="color: #999; margin-top: 40px;">Seek the floating heart to unveil the secret.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="heart-target">
        <i class="fa-solid fa-heart"></i>
    </div>

    <div id="rose-quote" class="rose-quote-overlay">
        <p class="quote-text">‚ÄúLove consists in this, that two solitudes protect and border and salute each other.‚Äù</p>
    </div>

    <audio id="bgMusic" loop>
        <source src="assets/music/first-love-2022.mp3" type="audio/mpeg">
    </audio>

    <script>
        let scene3d, camera, renderer, composer, particles, particleCount = 10000;
        let points = [], state = 'BACKGROUND', mouse = new THREE.Vector3(0, 0, 0);
        let clock = new THREE.Clock();
        let isCardOpen = false;
        let clicks = 0;

        function init() {
            scene3d = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2500);
            camera.position.z = 180;
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            const renderScene = new THREE.RenderPass(scene3d, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
            createParticles();
            animate();
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('resize', onWindowResize);
        }

        function createParticles() {
            const texture = new THREE.CanvasTexture(createHeartCanvas());
            const geo = new THREE.BufferGeometry();
            const pos = new Float32Array(particleCount * 3);
            const col = new Float32Array(particleCount * 3);
            const gold = new THREE.Color(0xd4af37);
            const ruby = new THREE.Color(0x9b111e);
            for(let i=0; i<particleCount; i++) {
                let x = (Math.random() - 0.5) * 1500;
                let y = (Math.random() - 0.5) * 1500;
                let z = (Math.random() - 0.5) * 1000 - 400;
                pos[i*3] = x; pos[i*3+1] = y; pos[i*3+2] = z;
                let c = gold.clone().lerp(ruby, Math.random() * 0.2);
                col[i*3] = c.r; col[i*3+1] = c.g; col[i*3+2] = c.b;
                points.push({ x: x, y: y, z: z, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, vz: (Math.random() - 0.5) * 0.1, phi: Math.random() * Math.PI * 2 });
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({ size: 4.5, map: texture, transparent: true, vertexColors: true, blending: THREE.AdditiveBlending, depthWrite: false, opacity: 0.52 });
            particles = new THREE.Points(geo, mat);
            scene3d.add(particles);
        }

        function createHeartCanvas() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = 'white';
            ctx.beginPath(); ctx.moveTo(32, 48); ctx.bezierCurveTo(12, 36, 12, 16, 32, 16); ctx.bezierCurveTo(52, 16, 52, 36, 32, 48); ctx.fill();
            return canvas;
        }

        function animate() {
            requestAnimationFrame(animate);
            const t = clock.getElapsedTime();
            const posAttr = particles.geometry.attributes.position;
            const colAttr = particles.geometry.attributes.color;
            for(let i=0; i<particleCount; i++) {
                let p = points[i];
                if(state === 'BACKGROUND') {
                    let dx = mouse.x * 300 - p.x; let dy = mouse.y * 300 - p.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 150) { p.vx += dx * 0.0008; p.vy += dy * 0.0008; }
                    p.vx *= 0.97; p.vy *= 0.97;
                    p.x += p.vx + Math.sin(t*0.3 + p.phi) * 0.03; p.y += p.vy + Math.cos(t*0.3 + p.phi) * 0.03; p.z += p.vz;
                    if(Math.abs(p.x) > 800) p.vx *= -1; if(Math.abs(p.y) > 800) p.vy *= -1;
                } else if (state === 'HEART') {
                    p.x += Math.sin(t * 0.5 + p.phi) * 0.15;
                    p.y += Math.cos(t * 0.5 + p.phi) * 0.15;
                    p.z += Math.sin(t * 0.8 + p.phi) * 0.08;
                }
                posAttr.array[i*3] = p.x; posAttr.array[i*3+1] = p.y; posAttr.array[i*3+2] = p.z;
            }
            if (state !== 'HEART_TRANSITION' && state !== 'HEART') {
                particles.rotation.y += (state === 'ROSE' ? 0.006 : 0.001);
            }
            posAttr.needsUpdate = true; colAttr.needsUpdate = true;
            composer.render();
        }

        function openBook() {
            if(isCardOpen) return;
            isCardOpen = true;
            document.getElementById('card-wrapper').classList.add('open');
            document.getElementById('card-inner').classList.add('is-open');
            const music = document.getElementById('bgMusic');
            music.volume = 0.6;
            const playMusic = () => { music.play().catch(() => {}); };
            playMusic();
            window.addEventListener('mousedown', playMusic, { once: true });
            if (!window.myAudioCtx) window.myAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
            setTimeout(spawnHeart, 2500);
        }

        function spawnHeart() {
            const h = document.getElementById('heart-target');
            h.style.display = 'flex';
            const x = 150 + Math.random()*(window.innerWidth-300);
            const y = 150 + Math.random()*(window.innerHeight-300);
            h.style.left = x + 'px'; h.style.top = y + 'px';
            gsap.fromTo(h, {scale:0, opacity:0}, {scale:1, opacity:1, duration:0.8, ease:"elastic.out(1, 0.3)"});
        }

        document.getElementById('heart-target').onclick = (e) => {
            e.stopPropagation();
            playDrop();
            const h = document.getElementById('heart-target');
            gsap.to(h, {scale: 0, opacity: 0, duration: 0.3, onComplete: () => {
                h.style.display = 'none';
                clicks++; if(clicks < 3) spawnHeart(); else triggerRose();
            }});
        };

        function playDrop() {
            const ctx = window.myAudioCtx; if(!ctx) return;
            const osc = ctx.createOscillator(); const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.setValueAtTime(1500, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 1.0);
            g.gain.setValueAtTime(0.4, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
            osc.start(); osc.stop(ctx.currentTime + 1.0);
        }

        function triggerRose() {
            state = 'ROSE_TRANSITION';
            gsap.to('#card-wrapper', { opacity: 0, y: 50, duration: 2, ease: "power2.inOut", onComplete: () => { document.getElementById('card-wrapper').style.display = 'none'; } });
            document.getElementById('dim-overlay').style.opacity = '0.95';
            const colAttr = particles.geometry.attributes.color.array;
            const posAttr = particles.geometry.attributes.position.array;
            const rubyColor = new THREE.Color(0x9b111e); const emeraldColor = new THREE.Color(0x50c878); const goldColor = new THREE.Color(0xd4af37);
            const raycaster = new THREE.Raycaster();
            const clickHandler = (event) => {
                if (state !== 'ROSE') return;
                const mousePos = new THREE.Vector2((event.clientX / window.innerWidth) * 2 - 1, -(event.clientY / window.innerHeight) * 2 + 1);
                raycaster.setFromCamera(mousePos, camera);
                const intersects = raycaster.intersectObject(particles);
                if (intersects.length > 0) transformToHeart();
            };
            window.addEventListener('click', clickHandler);
            points.forEach((p, i) => {
                const t = Math.random() * Math.PI * 2; const ph = Math.random() * Math.PI;
                let tx, ty, tz, targetC;
                if(i < particleCount * 0.65) { 
                    const r = 65 * Math.pow(Math.sin(ph), 0.5) * (1.0 + 0.3 * Math.sin(8 * t));
                    tx = r * Math.sin(ph) * Math.cos(t); ty = r * Math.sin(ph) * Math.sin(t) + Math.cos(ph) * 40; tz = r * Math.cos(ph);
                    targetC = Math.random() > 0.85 ? goldColor : rubyColor;
                } else if(i < particleCount * 0.85) { 
                    const braid = (i % 3); const angle = ph * 10 + (braid * Math.PI * 2 / 3);
                    const r = 3 + Math.sin(ph * 20) * 0.5;
                    tx = r * Math.cos(angle); ty = -ph * 70 - 25; tz = r * Math.sin(angle);
                    targetC = Math.random() > 0.9 ? goldColor : new THREE.Color(0x050505);
                } else { 
                    const side = Math.random() > 0.5 ? 1 : -1; const leafT = Math.random() * Math.PI;
                    const r = leafT * 25; tx = side * (r * Math.cos(leafT * 0.45)); ty = -60 - Math.random() * 60 + (r * Math.sin(leafT * 0.45)); tz = Math.sin(leafT * 6) * 15;
                    targetC = Math.random() > 0.88 ? goldColor : emeraldColor;
                }
                p.rosePos = { x: tx, y: ty, z: tz }; p.roseColor = targetC.clone();
                gsap.to(p, { x: tx, y: ty, z: tz, duration: 6, ease: "expo.inOut", delay: Math.random() * 1.5, onUpdate: () => { posAttr[i*3] = p.x; posAttr[i*3+1] = p.y; posAttr[i*3+2] = p.z; } });
                gsap.to({r: colAttr[i*3], g: colAttr[i*3+1], b: colAttr[i*3+2]}, { r: targetC.r, g: targetC.g, b: targetC.b, duration: 4, onUpdate: function() { colAttr[i*3] = this.targets()[0].r; colAttr[i*3+1] = this.targets()[0].g; colAttr[i*3+2] = this.targets()[0].b; } });
            });
            gsap.to(composer.passes[1], { strength: 3.0, radius: 1.8, duration: 7 });
            gsap.to(camera.position, { z: 220, duration: 8, ease: "power2.inOut" });
            gsap.to(particles.rotation, { y: particles.rotation.y + Math.PI, duration: 10, ease: "power1.inOut", onComplete: () => { gsap.to(particles.rotation, { y: "+=" + (Math.PI * 2), duration: 40, repeat: -1, ease: "none" }); } });
            setTimeout(() => { state = 'ROSE'; document.getElementById('rose-quote').style.opacity = '1'; }, 6500);
        }

        function transformToHeart() {
            if (state !== 'ROSE') return;
            state = 'HEART_TRANSITION';
            document.getElementById('rose-quote').style.opacity = '0';
            const posAttr = particles.geometry.attributes.position.array;
            const colAttr = particles.geometry.attributes.color.array;
            const heartColor = new THREE.Color(0xff3333);
            gsap.killTweensOf(particles.rotation);
            particles.material.opacity = 0.26;
            points.forEach((p, i) => {
                const t = Math.random() * Math.PI * 2;
                const hx = 16 * Math.pow(Math.sin(t), 3);
                const hy = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                const rFactor = Math.pow(Math.random(), 0.5); 
                const scale = 6.5; 
                const jitterX = (Math.random() - 0.5) * 15;
                const jitterY = (Math.random() - 0.5) * 15;
                const tx = hx * scale * rFactor + jitterX;
                const ty = hy * scale * rFactor + jitterY;
                const tz = (Math.random() - 0.5) * 20; 
                gsap.to(p, { x: tx, y: ty, z: tz, duration: 3, ease: "elastic.out(1, 0.75)", onUpdate: () => { posAttr[i*3] = p.x; posAttr[i*3+1] = p.y; posAttr[i*3+2] = p.z; } });
                gsap.to({r: colAttr[i*3], g: colAttr[i*3+1], b: colAttr[i*3+2]}, { r: heartColor.r, g: heartColor.g, b: heartColor.b, duration: 2, onUpdate: function() { colAttr[i*3] = this.targets()[0].r; colAttr[i*3+1] = this.targets()[0].g; colAttr[i*3+2] = this.targets()[0].b; } });
            });
            gsap.to(particles.rotation, { x: 0, y: 0, z: 0, duration: 2, onComplete: () => { state = 'HEART'; } });
            gsap.to(particles.scale, { x: 1.2, y: 1.2, z: 1.2, duration: 0.6, yoyo: true, repeat: 15, ease: "power2.inOut" });
            setTimeout(() => { revertToRose(); }, 10000);
        }

        function revertToRose() {
            state = 'ROSE_TRANSITION';
            const posAttr = particles.geometry.attributes.position.array;
            const colAttr = particles.geometry.attributes.color.array;
            particles.material.opacity = 0.52;
            points.forEach((p, i) => {
                gsap.to(p, { x: p.rosePos.x, y: p.rosePos.y, z: p.rosePos.z, duration: 3, ease: "power3.inOut", onUpdate: () => { posAttr[i*3] = p.x; posAttr[i*3+1] = p.y; posAttr[i*3+2] = p.z; } });
                gsap.to({r: colAttr[i*3], g: colAttr[i*3+1], b: colAttr[i*3+2]}, { r: p.roseColor.r, g: p.roseColor.g, b: p.roseColor.b, duration: 2, onUpdate: function() { colAttr[i*3] = this.targets()[0].r; colAttr[i*3+1] = this.targets()[0].g; colAttr[i*3+2] = this.targets()[0].b; } });
            });
            setTimeout(() => { state = 'ROSE'; document.getElementById('rose-quote').style.opacity = '1'; gsap.to(particles.scale, { x: 1, y: 1, z: 1, duration: 1 }); gsap.to(particles.rotation, { y: "+=" + (Math.PI * 2), duration: 40, repeat: -1, ease: "none" }); }, 3000);
        }

        function onMouseMove(e) { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; }
        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); }
        window.onload = init;
    </script>
</body>
</html>